{"nbformat":4,"nbformat_minor":0,"metadata":{"colab":{"name":"Model_light_5_users","provenance":[{"file_id":"1dxEIXi9mxgnkMg_LR1y3a9xCGB_u1nbE","timestamp":1596025189737}],"collapsed_sections":[],"authorship_tag":"ABX9TyN+FX0Xtp3I+M/2J496fOAY"},"kernelspec":{"name":"python3","display_name":"Python 3"},"widgets":{"application/vnd.jupyter.widget-state+json":{"c05b0563475b49a4ab3f383b15c38c66":{"model_module":"@jupyter-widgets/controls","model_name":"HBoxModel","state":{"_view_name":"HBoxView","_dom_classes":[],"_model_name":"HBoxModel","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.5.0","box_style":"","layout":"IPY_MODEL_5cf13be2b24c434881f7dfc6f90b24d6","_model_module":"@jupyter-widgets/controls","children":["IPY_MODEL_b61fbf0a1437490fbdc719079ab99bff","IPY_MODEL_a6d0df852f7a44bb817eecd097f4357a"]}},"5cf13be2b24c434881f7dfc6f90b24d6":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"b61fbf0a1437490fbdc719079ab99bff":{"model_module":"@jupyter-widgets/controls","model_name":"FloatProgressModel","state":{"_view_name":"ProgressView","style":"IPY_MODEL_7662d4ede2b94ad9a222ef11f8004497","_dom_classes":[],"description":"100%","_model_name":"FloatProgressModel","bar_style":"success","max":5,"_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":5,"_view_count":null,"_view_module_version":"1.5.0","orientation":"horizontal","min":0,"description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_2eda7c5dd8514e5f93040281634560a6"}},"a6d0df852f7a44bb817eecd097f4357a":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","state":{"_view_name":"HTMLView","style":"IPY_MODEL_cc7ea319ec424f0097f9e11c937e2d9a","_dom_classes":[],"description":"","_model_name":"HTMLModel","placeholder":"​","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":" 5/5 [21:40&lt;00:00, 260.09s/it]","_view_count":null,"_view_module_version":"1.5.0","description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_a1f93844fc394bbfa8eab2ec23c4349a"}},"7662d4ede2b94ad9a222ef11f8004497":{"model_module":"@jupyter-widgets/controls","model_name":"ProgressStyleModel","state":{"_view_name":"StyleView","_model_name":"ProgressStyleModel","description_width":"initial","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","bar_color":null,"_model_module":"@jupyter-widgets/controls"}},"2eda7c5dd8514e5f93040281634560a6":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"cc7ea319ec424f0097f9e11c937e2d9a":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","state":{"_view_name":"StyleView","_model_name":"DescriptionStyleModel","description_width":"","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","_model_module":"@jupyter-widgets/controls"}},"a1f93844fc394bbfa8eab2ec23c4349a":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}}}}},"cells":[{"cell_type":"markdown","metadata":{"id":"wLmcZoNzQnF2","colab_type":"text"},"source":["Модели типа logistic с фичами по товарам и пользователям с кросс валидацией"]},{"cell_type":"code","metadata":{"id":"FZAl3BS4Njp9","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":306},"executionInfo":{"status":"ok","timestamp":1596025248166,"user_tz":-180,"elapsed":13969,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"b0f57fb9-c9e1-483b-f130-099872773ee5"},"source":["pip install lightfm"],"execution_count":null,"outputs":[{"output_type":"stream","text":["Collecting lightfm\n","\u001b[?25l  Downloading https://files.pythonhosted.org/packages/e9/8e/5485ac5a8616abe1c673d1e033e2f232b4319ab95424b42499fabff2257f/lightfm-1.15.tar.gz (302kB)\n","\r\u001b[K     |█                               | 10kB 13.8MB/s eta 0:00:01\r\u001b[K     |██▏                             | 20kB 2.2MB/s eta 0:00:01\r\u001b[K     |███▎                            | 30kB 2.8MB/s eta 0:00:01\r\u001b[K     |████▍                           | 40kB 3.2MB/s eta 0:00:01\r\u001b[K     |█████▍                          | 51kB 2.5MB/s eta 0:00:01\r\u001b[K     |██████▌                         | 61kB 2.8MB/s eta 0:00:01\r\u001b[K     |███████▋                        | 71kB 3.1MB/s eta 0:00:01\r\u001b[K     |████████▊                       | 81kB 3.3MB/s eta 0:00:01\r\u001b[K     |█████████▊                      | 92kB 3.5MB/s eta 0:00:01\r\u001b[K     |██████████▉                     | 102kB 3.4MB/s eta 0:00:01\r\u001b[K     |████████████                    | 112kB 3.4MB/s eta 0:00:01\r\u001b[K     |█████████████                   | 122kB 3.4MB/s eta 0:00:01\r\u001b[K     |██████████████                  | 133kB 3.4MB/s eta 0:00:01\r\u001b[K     |███████████████▏                | 143kB 3.4MB/s eta 0:00:01\r\u001b[K     |████████████████▎               | 153kB 3.4MB/s eta 0:00:01\r\u001b[K     |█████████████████▍              | 163kB 3.4MB/s eta 0:00:01\r\u001b[K     |██████████████████▍             | 174kB 3.4MB/s eta 0:00:01\r\u001b[K     |███████████████████▌            | 184kB 3.4MB/s eta 0:00:01\r\u001b[K     |████████████████████▋           | 194kB 3.4MB/s eta 0:00:01\r\u001b[K     |█████████████████████▊          | 204kB 3.4MB/s eta 0:00:01\r\u001b[K     |██████████████████████▊         | 215kB 3.4MB/s eta 0:00:01\r\u001b[K     |███████████████████████▉        | 225kB 3.4MB/s eta 0:00:01\r\u001b[K     |█████████████████████████       | 235kB 3.4MB/s eta 0:00:01\r\u001b[K     |██████████████████████████      | 245kB 3.4MB/s eta 0:00:01\r\u001b[K     |███████████████████████████     | 256kB 3.4MB/s eta 0:00:01\r\u001b[K     |████████████████████████████▏   | 266kB 3.4MB/s eta 0:00:01\r\u001b[K     |█████████████████████████████▎  | 276kB 3.4MB/s eta 0:00:01\r\u001b[K     |██████████████████████████████▍ | 286kB 3.4MB/s eta 0:00:01\r\u001b[K     |███████████████████████████████▍| 296kB 3.4MB/s eta 0:00:01\r\u001b[K     |████████████████████████████████| 307kB 3.4MB/s \n","\u001b[?25hRequirement already satisfied: numpy in /usr/local/lib/python3.6/dist-packages (from lightfm) (1.18.5)\n","Requirement already satisfied: scipy>=0.17.0 in /usr/local/lib/python3.6/dist-packages (from lightfm) (1.4.1)\n","Requirement already satisfied: requests in /usr/local/lib/python3.6/dist-packages (from lightfm) (2.23.0)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.6/dist-packages (from requests->lightfm) (2020.6.20)\n","Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /usr/local/lib/python3.6/dist-packages (from requests->lightfm) (1.24.3)\n","Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.6/dist-packages (from requests->lightfm) (2.10)\n","Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.6/dist-packages (from requests->lightfm) (3.0.4)\n","Building wheels for collected packages: lightfm\n","  Building wheel for lightfm (setup.py) ... \u001b[?25l\u001b[?25hdone\n","  Created wheel for lightfm: filename=lightfm-1.15-cp36-cp36m-linux_x86_64.whl size=707618 sha256=887842bdc652a51ac797b46dc672b71c9b5685835f5c43470418cf382b8fcc37\n","  Stored in directory: /root/.cache/pip/wheels/eb/bb/ac/188385a5da6627956be5d9663928483b36da576149ab5b8f79\n","Successfully built lightfm\n","Installing collected packages: lightfm\n","Successfully installed lightfm-1.15\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"nkf06qVWTssn","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":122},"executionInfo":{"status":"ok","timestamp":1596025271399,"user_tz":-180,"elapsed":21852,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"310645f8-8ec2-42c8-d765-2220ec78858b"},"source":["from google.colab import drive\n","drive.mount('/content/drive/')\n","\n","DIR = '/content/drive/My Drive/Colab Notebooks/Data_Sceince/Module_5/recommendationsv4/'\n","DIR_TEST = '/content/drive/My Drive/Colab Notebooks/Data_Sceince/Module_5/TEST/'"],"execution_count":null,"outputs":[{"output_type":"stream","text":["Go to this URL in a browser: https://accounts.google.com/o/oauth2/auth?client_id=947318989803-6bn6qk8qdgf4n4g3pfee6491hc0brc4i.apps.googleusercontent.com&redirect_uri=urn%3aietf%3awg%3aoauth%3a2.0%3aoob&response_type=code&scope=email%20https%3a%2f%2fwww.googleapis.com%2fauth%2fdocs.test%20https%3a%2f%2fwww.googleapis.com%2fauth%2fdrive%20https%3a%2f%2fwww.googleapis.com%2fauth%2fdrive.photos.readonly%20https%3a%2f%2fwww.googleapis.com%2fauth%2fpeopleapi.readonly\n","\n","Enter your authorization code:\n","··········\n","Mounted at /content/drive/\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"XFzmuwu8TrAC","colab_type":"code","colab":{}},"source":["%matplotlib inline\n","import numpy as np # linear algebra\n","import pandas as pd\n","from sklearn.model_selection import KFold\n","from sklearn.model_selection import StratifiedKFold\n","from tqdm.notebook import tqdm\n"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"tGl47lXoMGg4","colab_type":"code","colab":{}},"source":["import scipy.sparse as sparse\n","\n","from lightfm import LightFM\n","from lightfm.cross_validation import random_train_test_split\n","from lightfm.evaluation import auc_score, precision_at_k, recall_at_k\n","import sklearn\n","from sklearn.model_selection import train_test_split\n","\n","from lightfm.data import Dataset"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"XXzsyYOaL-jd","colab_type":"code","colab":{}},"source":["#Читаем файлы\n","data = pd.read_csv(DIR + 'train.csv',low_memory=False )\n","test = pd.read_csv(DIR +'test.csv',low_memory=False )\n","submission = pd.read_csv(DIR +'sample_submission.csv')"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"hK-j0r87D8hw","colab_type":"code","colab":{}},"source":["fichi = pd.read_csv(DIR + 'fi4i30T.csv',low_memory=False) #, nrows = 5 )"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"SWTNm8DqUIrd","colab_type":"code","colab":{}},"source":["fichi.describe()"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"OIPRRFfTGdTY","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":224},"executionInfo":{"status":"ok","timestamp":1595968348732,"user_tz":-180,"elapsed":549,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"bea00bc2-5fbb-4297-a650-e161c9503065"},"source":["fichi.head()"],"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/html":["<div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>itemid</th>\n","      <th>userid</th>\n","      <th>overall</th>\n","      <th>id</th>\n","      <th>0</th>\n","      <th>1</th>\n","      <th>2</th>\n","      <th>3</th>\n","      <th>4</th>\n","      <th>5</th>\n","      <th>6</th>\n","      <th>7</th>\n","      <th>8</th>\n","      <th>9</th>\n","      <th>10</th>\n","      <th>11</th>\n","      <th>12</th>\n","      <th>13</th>\n","      <th>14</th>\n","      <th>15</th>\n","      <th>16</th>\n","      <th>17</th>\n","      <th>18</th>\n","      <th>19</th>\n","      <th>20</th>\n","      <th>21</th>\n","      <th>22</th>\n","      <th>23</th>\n","      <th>24</th>\n","      <th>25</th>\n","      <th>26</th>\n","      <th>27</th>\n","      <th>28</th>\n","      <th>29</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>37138</td>\n","      <td>102179</td>\n","      <td>5.0</td>\n","      <td>0</td>\n","      <td>-0.481626</td>\n","      <td>-0.146912</td>\n","      <td>-0.461433</td>\n","      <td>0.627254</td>\n","      <td>0.490984</td>\n","      <td>0.068531</td>\n","      <td>-0.175226</td>\n","      <td>-0.101846</td>\n","      <td>-0.392405</td>\n","      <td>-0.067195</td>\n","      <td>-0.881019</td>\n","      <td>-0.086871</td>\n","      <td>-0.111445</td>\n","      <td>0.019312</td>\n","      <td>-0.323024</td>\n","      <td>0.299162</td>\n","      <td>0.178909</td>\n","      <td>0.363466</td>\n","      <td>0.054027</td>\n","      <td>0.252262</td>\n","      <td>0.131708</td>\n","      <td>-0.467254</td>\n","      <td>0.025174</td>\n","      <td>-0.539695</td>\n","      <td>-0.438329</td>\n","      <td>0.651743</td>\n","      <td>0.215715</td>\n","      <td>0.094889</td>\n","      <td>0.171043</td>\n","      <td>0.420939</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>17322</td>\n","      <td>3625</td>\n","      <td>5.0</td>\n","      <td>1</td>\n","      <td>-0.487150</td>\n","      <td>-0.490408</td>\n","      <td>-0.863708</td>\n","      <td>1.268813</td>\n","      <td>0.201121</td>\n","      <td>-0.341024</td>\n","      <td>-0.014472</td>\n","      <td>0.182113</td>\n","      <td>-0.661514</td>\n","      <td>0.008635</td>\n","      <td>-0.278071</td>\n","      <td>0.004864</td>\n","      <td>0.820423</td>\n","      <td>0.140630</td>\n","      <td>-0.317460</td>\n","      <td>-0.323987</td>\n","      <td>0.563939</td>\n","      <td>0.943316</td>\n","      <td>0.593163</td>\n","      <td>0.602663</td>\n","      <td>0.360174</td>\n","      <td>0.139982</td>\n","      <td>-0.408589</td>\n","      <td>0.036960</td>\n","      <td>0.035105</td>\n","      <td>-0.148636</td>\n","      <td>0.650877</td>\n","      <td>-0.138781</td>\n","      <td>0.217508</td>\n","      <td>0.681503</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>5600</td>\n","      <td>39495</td>\n","      <td>5.0</td>\n","      <td>2</td>\n","      <td>-0.030458</td>\n","      <td>-0.482874</td>\n","      <td>0.305205</td>\n","      <td>0.531545</td>\n","      <td>0.027049</td>\n","      <td>0.200568</td>\n","      <td>0.163929</td>\n","      <td>0.374942</td>\n","      <td>-0.366942</td>\n","      <td>0.171773</td>\n","      <td>0.039992</td>\n","      <td>-0.521756</td>\n","      <td>0.514570</td>\n","      <td>-0.051424</td>\n","      <td>-0.705174</td>\n","      <td>-0.092675</td>\n","      <td>0.178857</td>\n","      <td>0.180742</td>\n","      <td>0.430242</td>\n","      <td>-0.125441</td>\n","      <td>0.086506</td>\n","      <td>0.553647</td>\n","      <td>-0.293880</td>\n","      <td>0.111545</td>\n","      <td>0.014612</td>\n","      <td>-0.491548</td>\n","      <td>0.151792</td>\n","      <td>0.182814</td>\n","      <td>-0.080710</td>\n","      <td>0.355633</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>30249</td>\n","      <td>72854</td>\n","      <td>5.0</td>\n","      <td>3</td>\n","      <td>-0.265692</td>\n","      <td>-0.518816</td>\n","      <td>-0.034628</td>\n","      <td>0.370477</td>\n","      <td>0.138180</td>\n","      <td>-0.112502</td>\n","      <td>0.164425</td>\n","      <td>-0.046640</td>\n","      <td>-0.102842</td>\n","      <td>-0.267234</td>\n","      <td>-0.751457</td>\n","      <td>0.183983</td>\n","      <td>-0.119559</td>\n","      <td>0.356675</td>\n","      <td>-0.414000</td>\n","      <td>0.159884</td>\n","      <td>0.096142</td>\n","      <td>0.354406</td>\n","      <td>0.451528</td>\n","      <td>-0.189015</td>\n","      <td>0.048574</td>\n","      <td>-0.288945</td>\n","      <td>-0.032130</td>\n","      <td>-0.576467</td>\n","      <td>-0.210558</td>\n","      <td>0.164137</td>\n","      <td>0.283811</td>\n","      <td>-0.013973</td>\n","      <td>0.111765</td>\n","      <td>-0.013857</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>4349</td>\n","      <td>74859</td>\n","      <td>5.0</td>\n","      <td>4</td>\n","      <td>0.260096</td>\n","      <td>0.089920</td>\n","      <td>0.311937</td>\n","      <td>0.956379</td>\n","      <td>0.644498</td>\n","      <td>0.331261</td>\n","      <td>-0.254293</td>\n","      <td>0.182654</td>\n","      <td>-0.053495</td>\n","      <td>0.599993</td>\n","      <td>0.234138</td>\n","      <td>-0.523378</td>\n","      <td>1.030362</td>\n","      <td>-0.525004</td>\n","      <td>-0.100578</td>\n","      <td>1.263725</td>\n","      <td>0.399474</td>\n","      <td>1.009355</td>\n","      <td>0.203495</td>\n","      <td>0.404312</td>\n","      <td>-0.248540</td>\n","      <td>0.814974</td>\n","      <td>0.719038</td>\n","      <td>-1.018465</td>\n","      <td>-0.174331</td>\n","      <td>0.565271</td>\n","      <td>0.515446</td>\n","      <td>-0.446922</td>\n","      <td>-0.419972</td>\n","      <td>0.017191</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>"],"text/plain":["   itemid  userid  overall  id  ...        26        27        28        29\n","0   37138  102179      5.0   0  ...  0.215715  0.094889  0.171043  0.420939\n","1   17322    3625      5.0   1  ...  0.650877 -0.138781  0.217508  0.681503\n","2    5600   39495      5.0   2  ...  0.151792  0.182814 -0.080710  0.355633\n","3   30249   72854      5.0   3  ...  0.283811 -0.013973  0.111765 -0.013857\n","4    4349   74859      5.0   4  ...  0.515446 -0.446922 -0.419972  0.017191\n","\n","[5 rows x 34 columns]"]},"metadata":{"tags":[]},"execution_count":18}]},{"cell_type":"code","metadata":{"id":"2tT01ChZG0BS","colab_type":"code","colab":{}},"source":["fichi = fichi.rename(columns={'Unnamed: 0':'id'},)\n","fichi = pd.concat([data[['userid']],fichi], axis =1, copy = 'False')"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"ANRpER8VH9oV","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":224},"executionInfo":{"status":"ok","timestamp":1596025328011,"user_tz":-180,"elapsed":650,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"3c35e3d8-50e1-46bc-9ced-259cc8f8a081"},"source":["fichi.head()"],"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/html":["<div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>userid</th>\n","      <th>id</th>\n","      <th>0</th>\n","      <th>1</th>\n","      <th>2</th>\n","      <th>3</th>\n","      <th>4</th>\n","      <th>5</th>\n","      <th>6</th>\n","      <th>7</th>\n","      <th>8</th>\n","      <th>9</th>\n","      <th>10</th>\n","      <th>11</th>\n","      <th>12</th>\n","      <th>13</th>\n","      <th>14</th>\n","      <th>15</th>\n","      <th>16</th>\n","      <th>17</th>\n","      <th>18</th>\n","      <th>19</th>\n","      <th>20</th>\n","      <th>21</th>\n","      <th>22</th>\n","      <th>23</th>\n","      <th>24</th>\n","      <th>25</th>\n","      <th>26</th>\n","      <th>27</th>\n","      <th>28</th>\n","      <th>29</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>102179</td>\n","      <td>0</td>\n","      <td>-0.481626</td>\n","      <td>-0.146912</td>\n","      <td>-0.461433</td>\n","      <td>0.627254</td>\n","      <td>0.490984</td>\n","      <td>0.068531</td>\n","      <td>-0.175226</td>\n","      <td>-0.101846</td>\n","      <td>-0.392405</td>\n","      <td>-0.067195</td>\n","      <td>-0.881019</td>\n","      <td>-0.086871</td>\n","      <td>-0.111445</td>\n","      <td>0.019312</td>\n","      <td>-0.323024</td>\n","      <td>0.299162</td>\n","      <td>0.178909</td>\n","      <td>0.363466</td>\n","      <td>0.054027</td>\n","      <td>0.252262</td>\n","      <td>0.131708</td>\n","      <td>-0.467254</td>\n","      <td>0.025174</td>\n","      <td>-0.539695</td>\n","      <td>-0.438329</td>\n","      <td>0.651743</td>\n","      <td>0.215715</td>\n","      <td>0.094889</td>\n","      <td>0.171043</td>\n","      <td>0.420939</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>3625</td>\n","      <td>1</td>\n","      <td>-0.487150</td>\n","      <td>-0.490408</td>\n","      <td>-0.863708</td>\n","      <td>1.268813</td>\n","      <td>0.201121</td>\n","      <td>-0.341024</td>\n","      <td>-0.014472</td>\n","      <td>0.182113</td>\n","      <td>-0.661514</td>\n","      <td>0.008635</td>\n","      <td>-0.278071</td>\n","      <td>0.004864</td>\n","      <td>0.820423</td>\n","      <td>0.140630</td>\n","      <td>-0.317460</td>\n","      <td>-0.323987</td>\n","      <td>0.563939</td>\n","      <td>0.943316</td>\n","      <td>0.593163</td>\n","      <td>0.602663</td>\n","      <td>0.360174</td>\n","      <td>0.139982</td>\n","      <td>-0.408589</td>\n","      <td>0.036960</td>\n","      <td>0.035105</td>\n","      <td>-0.148636</td>\n","      <td>0.650877</td>\n","      <td>-0.138781</td>\n","      <td>0.217508</td>\n","      <td>0.681503</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>39495</td>\n","      <td>2</td>\n","      <td>-0.030458</td>\n","      <td>-0.482874</td>\n","      <td>0.305205</td>\n","      <td>0.531545</td>\n","      <td>0.027049</td>\n","      <td>0.200568</td>\n","      <td>0.163929</td>\n","      <td>0.374942</td>\n","      <td>-0.366942</td>\n","      <td>0.171773</td>\n","      <td>0.039992</td>\n","      <td>-0.521756</td>\n","      <td>0.514570</td>\n","      <td>-0.051424</td>\n","      <td>-0.705174</td>\n","      <td>-0.092675</td>\n","      <td>0.178857</td>\n","      <td>0.180742</td>\n","      <td>0.430242</td>\n","      <td>-0.125441</td>\n","      <td>0.086506</td>\n","      <td>0.553647</td>\n","      <td>-0.293880</td>\n","      <td>0.111545</td>\n","      <td>0.014612</td>\n","      <td>-0.491548</td>\n","      <td>0.151792</td>\n","      <td>0.182814</td>\n","      <td>-0.080710</td>\n","      <td>0.355633</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>72854</td>\n","      <td>3</td>\n","      <td>-0.265692</td>\n","      <td>-0.518816</td>\n","      <td>-0.034628</td>\n","      <td>0.370477</td>\n","      <td>0.138180</td>\n","      <td>-0.112502</td>\n","      <td>0.164425</td>\n","      <td>-0.046640</td>\n","      <td>-0.102842</td>\n","      <td>-0.267234</td>\n","      <td>-0.751457</td>\n","      <td>0.183983</td>\n","      <td>-0.119559</td>\n","      <td>0.356675</td>\n","      <td>-0.414000</td>\n","      <td>0.159884</td>\n","      <td>0.096142</td>\n","      <td>0.354406</td>\n","      <td>0.451528</td>\n","      <td>-0.189015</td>\n","      <td>0.048574</td>\n","      <td>-0.288945</td>\n","      <td>-0.032130</td>\n","      <td>-0.576467</td>\n","      <td>-0.210558</td>\n","      <td>0.164137</td>\n","      <td>0.283811</td>\n","      <td>-0.013973</td>\n","      <td>0.111765</td>\n","      <td>-0.013857</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>74859</td>\n","      <td>4</td>\n","      <td>0.260096</td>\n","      <td>0.089920</td>\n","      <td>0.311937</td>\n","      <td>0.956379</td>\n","      <td>0.644498</td>\n","      <td>0.331261</td>\n","      <td>-0.254293</td>\n","      <td>0.182654</td>\n","      <td>-0.053495</td>\n","      <td>0.599993</td>\n","      <td>0.234138</td>\n","      <td>-0.523378</td>\n","      <td>1.030362</td>\n","      <td>-0.525004</td>\n","      <td>-0.100578</td>\n","      <td>1.263725</td>\n","      <td>0.399474</td>\n","      <td>1.009355</td>\n","      <td>0.203495</td>\n","      <td>0.404312</td>\n","      <td>-0.248540</td>\n","      <td>0.814974</td>\n","      <td>0.719038</td>\n","      <td>-1.018465</td>\n","      <td>-0.174331</td>\n","      <td>0.565271</td>\n","      <td>0.515446</td>\n","      <td>-0.446922</td>\n","      <td>-0.419972</td>\n","      <td>0.017191</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>"],"text/plain":["   userid  id         0         1  ...        26        27        28        29\n","0  102179   0 -0.481626 -0.146912  ...  0.215715  0.094889  0.171043  0.420939\n","1    3625   1 -0.487150 -0.490408  ...  0.650877 -0.138781  0.217508  0.681503\n","2   39495   2 -0.030458 -0.482874  ...  0.151792  0.182814 -0.080710  0.355633\n","3   72854   3 -0.265692 -0.518816  ...  0.283811 -0.013973  0.111765 -0.013857\n","4   74859   4  0.260096  0.089920  ...  0.515446 -0.446922 -0.419972  0.017191\n","\n","[5 rows x 32 columns]"]},"metadata":{"tags":[]},"execution_count":8}]},{"cell_type":"code","metadata":{"id":"XbuPtScEatIi","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":204},"executionInfo":{"status":"ok","timestamp":1596025366175,"user_tz":-180,"elapsed":668,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"6b08884e-565e-419c-9217-d0c3473a2481"},"source":["data.head()"],"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/html":["<div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>overall</th>\n","      <th>verified</th>\n","      <th>reviewTime</th>\n","      <th>asin</th>\n","      <th>reviewerName</th>\n","      <th>reviewText</th>\n","      <th>summary</th>\n","      <th>unixReviewTime</th>\n","      <th>vote</th>\n","      <th>style</th>\n","      <th>image</th>\n","      <th>userid</th>\n","      <th>itemid</th>\n","      <th>rating</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>139377</th>\n","      <td>5.0</td>\n","      <td>False</td>\n","      <td>08 9, 2000</td>\n","      <td>B00004S1C5</td>\n","      <td>Stephanie Manley</td>\n","      <td>This are so much easier to use than the Wilson...</td>\n","      <td>Very easy to use</td>\n","      <td>965779200</td>\n","      <td>9</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>142</td>\n","      <td>4</td>\n","      <td>1.0</td>\n","    </tr>\n","    <tr>\n","      <th>827509</th>\n","      <td>5.0</td>\n","      <td>False</td>\n","      <td>11 30, 2002</td>\n","      <td>B00004W4VD</td>\n","      <td>Shari M. Lowery</td>\n","      <td>The Nesco American Harvest Jerky Works has mad...</td>\n","      <td>Outstanding Product...</td>\n","      <td>1038614400</td>\n","      <td>11</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>156</td>\n","      <td>5</td>\n","      <td>1.0</td>\n","    </tr>\n","    <tr>\n","      <th>444617</th>\n","      <td>5.0</td>\n","      <td>False</td>\n","      <td>12 5, 2003</td>\n","      <td>B0000DBN2F</td>\n","      <td>Rebecca of Amazon</td>\n","      <td>Blend a little apple cider mix into your Tazo ...</td>\n","      <td>Spice It Up for the Holidays</td>\n","      <td>1070582400</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>1874</td>\n","      <td>83</td>\n","      <td>1.0</td>\n","    </tr>\n","    <tr>\n","      <th>551053</th>\n","      <td>5.0</td>\n","      <td>False</td>\n","      <td>12 14, 2003</td>\n","      <td>B000R4LP6M</td>\n","      <td>Westley</td>\n","      <td>Tapatio salsa picante is one of my favorite ho...</td>\n","      <td>Fantastic Smoky Flavor</td>\n","      <td>1071360000</td>\n","      <td>2</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>15372</td>\n","      <td>4326</td>\n","      <td>1.0</td>\n","    </tr>\n","    <tr>\n","      <th>506098</th>\n","      <td>5.0</td>\n","      <td>False</td>\n","      <td>03 26, 2004</td>\n","      <td>B000PILJ5C</td>\n","      <td>Jess</td>\n","      <td>I have suffered from horrible periods since I ...</td>\n","      <td>It does what it promises and has a refreshing ...</td>\n","      <td>1080259200</td>\n","      <td>15</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>73762</td>\n","      <td>4095</td>\n","      <td>1.0</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>"],"text/plain":["        overall  verified   reviewTime  ... userid itemid rating\n","139377      5.0     False   08 9, 2000  ...    142      4    1.0\n","827509      5.0     False  11 30, 2002  ...    156      5    1.0\n","444617      5.0     False   12 5, 2003  ...   1874     83    1.0\n","551053      5.0     False  12 14, 2003  ...  15372   4326    1.0\n","506098      5.0     False  03 26, 2004  ...  73762   4095    1.0\n","\n","[5 rows x 14 columns]"]},"metadata":{"tags":[]},"execution_count":14}]},{"cell_type":"code","metadata":{"id":"kE96tGJP_18u","colab_type":"code","colab":{}},"source":["# Определяем выбросы, вероятно спам\n","def get_spam(field):\n","  med = data[field].value_counts().describe()['50%']\n","  std = data[field].value_counts().describe()['std']\n","  counts = pd.DataFrame(data[field].value_counts())\n","  spam = list(counts[counts[field] > med + 3 * std].index)\n","  return spam"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"HQkBb4HmA_9i","colab_type":"code","colab":{}},"source":["item_spam = get_spam('itemid')\n","user_spam = get_spam('userid')\n","data = data[~((data['itemid'].isin(item_spam)) & (data['userid'].isin(user_spam)))]"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"2TzH2tBJFWqR","colab_type":"code","colab":{}},"source":["# Упорядочим наши данные по верифицированности ответа и времени\n","data.sort_values(by = ['verified', 'unixReviewTime'], ascending= True, inplace = True)"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"mraekibqFijF","colab_type":"code","colab":{}},"source":["#Удалим дубли, оставим только по одной паре  пользователь товар\n","#оставим последний отзыв,считая, что  могут меняться вкусы и качество товаров\n","data.drop_duplicates(subset =['userid','unixReviewTime','itemid'], keep = 'last',inplace = True)\n"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"_nt0wlm5RytT","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":34},"executionInfo":{"status":"ok","timestamp":1595512451118,"user_tz":-180,"elapsed":902,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"4e796007-234f-4a3d-d0d1-8c91803308a9"},"source":["len(data), len(test),  len(test)/len(data)"],"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["(806942, 285965, 0.35438110793588634)"]},"metadata":{"tags":[]},"execution_count":11}]},{"cell_type":"code","metadata":{"id":"jksQCCCIxf6o","colab_type":"code","colab":{}},"source":["data = data.reset_index()"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"LAgUFP9WJcTc","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":470},"executionInfo":{"status":"ok","timestamp":1596025373588,"user_tz":-180,"elapsed":1414,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"0b68d242-7a32-4051-974a-fe6a09aaf4fe"},"source":["fichi = fichi[fichi['id'].isin(data['index'])]\n","fichi_user = fichi.groupby('userid').mean()\n","\n","fichi_user.drop(columns=['id'], inplace=True )\n","fichi_user"],"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/html":["<div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>0</th>\n","      <th>1</th>\n","      <th>2</th>\n","      <th>3</th>\n","      <th>4</th>\n","      <th>5</th>\n","      <th>6</th>\n","      <th>7</th>\n","      <th>8</th>\n","      <th>9</th>\n","      <th>10</th>\n","      <th>11</th>\n","      <th>12</th>\n","      <th>13</th>\n","      <th>14</th>\n","      <th>15</th>\n","      <th>16</th>\n","      <th>17</th>\n","      <th>18</th>\n","      <th>19</th>\n","      <th>20</th>\n","      <th>21</th>\n","      <th>22</th>\n","      <th>23</th>\n","      <th>24</th>\n","      <th>25</th>\n","      <th>26</th>\n","      <th>27</th>\n","      <th>28</th>\n","      <th>29</th>\n","    </tr>\n","    <tr>\n","      <th>userid</th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","      <th></th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>-0.414023</td>\n","      <td>0.573671</td>\n","      <td>-0.466751</td>\n","      <td>-0.486914</td>\n","      <td>0.176791</td>\n","      <td>0.650737</td>\n","      <td>-0.299078</td>\n","      <td>0.055431</td>\n","      <td>-0.106625</td>\n","      <td>-0.036879</td>\n","      <td>-1.102718</td>\n","      <td>-0.257848</td>\n","      <td>-0.912889</td>\n","      <td>0.378128</td>\n","      <td>0.463470</td>\n","      <td>0.063092</td>\n","      <td>-0.416800</td>\n","      <td>-0.488641</td>\n","      <td>0.109133</td>\n","      <td>-0.477623</td>\n","      <td>0.368227</td>\n","      <td>1.281831</td>\n","      <td>-0.851987</td>\n","      <td>1.464920</td>\n","      <td>0.906994</td>\n","      <td>-0.061233</td>\n","      <td>-0.212764</td>\n","      <td>-0.371089</td>\n","      <td>-0.086386</td>\n","      <td>0.669767</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>-0.473889</td>\n","      <td>-0.131186</td>\n","      <td>0.104379</td>\n","      <td>0.110335</td>\n","      <td>-0.297053</td>\n","      <td>0.073472</td>\n","      <td>-0.301158</td>\n","      <td>0.043840</td>\n","      <td>0.099704</td>\n","      <td>-0.127024</td>\n","      <td>-0.342371</td>\n","      <td>-0.192074</td>\n","      <td>-0.111711</td>\n","      <td>0.127679</td>\n","      <td>-0.438065</td>\n","      <td>0.259409</td>\n","      <td>-0.061917</td>\n","      <td>-0.468077</td>\n","      <td>-0.183858</td>\n","      <td>-0.244458</td>\n","      <td>-0.079782</td>\n","      <td>-0.342786</td>\n","      <td>-0.636168</td>\n","      <td>-0.015975</td>\n","      <td>0.343880</td>\n","      <td>-0.239369</td>\n","      <td>-0.359413</td>\n","      <td>-0.213119</td>\n","      <td>0.152553</td>\n","      <td>0.554046</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>-0.083034</td>\n","      <td>0.034994</td>\n","      <td>0.262354</td>\n","      <td>0.665764</td>\n","      <td>-0.237267</td>\n","      <td>-0.247594</td>\n","      <td>0.200038</td>\n","      <td>0.520357</td>\n","      <td>-0.295003</td>\n","      <td>0.072914</td>\n","      <td>-0.094682</td>\n","      <td>-0.410981</td>\n","      <td>0.431512</td>\n","      <td>-0.203372</td>\n","      <td>-0.658337</td>\n","      <td>0.181861</td>\n","      <td>0.489063</td>\n","      <td>0.334488</td>\n","      <td>0.491160</td>\n","      <td>-0.156633</td>\n","      <td>-0.090893</td>\n","      <td>0.023826</td>\n","      <td>-0.151006</td>\n","      <td>-0.188061</td>\n","      <td>0.181420</td>\n","      <td>-0.381782</td>\n","      <td>0.145217</td>\n","      <td>-0.013698</td>\n","      <td>-0.374472</td>\n","      <td>0.526813</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>-0.207925</td>\n","      <td>-0.154537</td>\n","      <td>0.200064</td>\n","      <td>0.632794</td>\n","      <td>-0.103974</td>\n","      <td>0.029883</td>\n","      <td>-0.093777</td>\n","      <td>0.225340</td>\n","      <td>0.050834</td>\n","      <td>-0.044944</td>\n","      <td>-0.098848</td>\n","      <td>-0.085857</td>\n","      <td>0.229972</td>\n","      <td>-0.018683</td>\n","      <td>-0.269769</td>\n","      <td>0.191831</td>\n","      <td>0.279944</td>\n","      <td>0.008246</td>\n","      <td>0.113414</td>\n","      <td>-0.235464</td>\n","      <td>-0.147571</td>\n","      <td>0.407872</td>\n","      <td>-0.303494</td>\n","      <td>0.032493</td>\n","      <td>0.312603</td>\n","      <td>-0.450149</td>\n","      <td>-0.042108</td>\n","      <td>-0.231564</td>\n","      <td>-0.040502</td>\n","      <td>0.450197</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>-0.562584</td>\n","      <td>-0.298769</td>\n","      <td>0.687209</td>\n","      <td>0.027878</td>\n","      <td>-0.229159</td>\n","      <td>-0.037652</td>\n","      <td>-0.367445</td>\n","      <td>0.753560</td>\n","      <td>-0.180722</td>\n","      <td>-0.370081</td>\n","      <td>0.245327</td>\n","      <td>-0.564209</td>\n","      <td>0.224255</td>\n","      <td>0.437975</td>\n","      <td>-0.457192</td>\n","      <td>0.272566</td>\n","      <td>0.174541</td>\n","      <td>-0.424752</td>\n","      <td>0.841026</td>\n","      <td>0.287557</td>\n","      <td>0.357524</td>\n","      <td>-0.372782</td>\n","      <td>-0.283749</td>\n","      <td>0.761596</td>\n","      <td>-0.098853</td>\n","      <td>0.152141</td>\n","      <td>-0.215025</td>\n","      <td>-0.415195</td>\n","      <td>-0.082853</td>\n","      <td>0.344746</td>\n","    </tr>\n","    <tr>\n","      <th>...</th>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","      <td>...</td>\n","    </tr>\n","    <tr>\n","      <th>127491</th>\n","      <td>-0.171731</td>\n","      <td>-0.292508</td>\n","      <td>-0.084355</td>\n","      <td>0.262250</td>\n","      <td>-0.360784</td>\n","      <td>0.328295</td>\n","      <td>-0.345818</td>\n","      <td>-0.068277</td>\n","      <td>0.164417</td>\n","      <td>0.455658</td>\n","      <td>-0.304206</td>\n","      <td>0.086377</td>\n","      <td>0.322038</td>\n","      <td>0.222412</td>\n","      <td>-0.377792</td>\n","      <td>0.357930</td>\n","      <td>-0.040731</td>\n","      <td>0.408787</td>\n","      <td>-0.115025</td>\n","      <td>0.082772</td>\n","      <td>-0.424482</td>\n","      <td>0.180980</td>\n","      <td>-0.135821</td>\n","      <td>-0.602326</td>\n","      <td>0.043239</td>\n","      <td>-0.367385</td>\n","      <td>-0.061285</td>\n","      <td>-0.282298</td>\n","      <td>0.308017</td>\n","      <td>0.732400</td>\n","    </tr>\n","    <tr>\n","      <th>127492</th>\n","      <td>-0.117186</td>\n","      <td>-0.032770</td>\n","      <td>0.206553</td>\n","      <td>0.921429</td>\n","      <td>0.090460</td>\n","      <td>-0.008201</td>\n","      <td>-0.171495</td>\n","      <td>0.287463</td>\n","      <td>-0.523292</td>\n","      <td>0.724387</td>\n","      <td>-0.273232</td>\n","      <td>-0.514711</td>\n","      <td>0.638894</td>\n","      <td>-0.311819</td>\n","      <td>-0.670167</td>\n","      <td>0.581010</td>\n","      <td>0.191574</td>\n","      <td>0.163404</td>\n","      <td>0.160443</td>\n","      <td>-0.207914</td>\n","      <td>-0.163068</td>\n","      <td>0.171015</td>\n","      <td>-0.093331</td>\n","      <td>-0.339307</td>\n","      <td>-0.339726</td>\n","      <td>-0.387873</td>\n","      <td>0.008461</td>\n","      <td>-0.107245</td>\n","      <td>-0.618327</td>\n","      <td>1.007551</td>\n","    </tr>\n","    <tr>\n","      <th>127493</th>\n","      <td>-0.293894</td>\n","      <td>-0.303011</td>\n","      <td>-0.067055</td>\n","      <td>0.279993</td>\n","      <td>-0.137539</td>\n","      <td>0.283358</td>\n","      <td>-0.159617</td>\n","      <td>-0.271246</td>\n","      <td>-0.096701</td>\n","      <td>0.414746</td>\n","      <td>-0.505187</td>\n","      <td>0.017551</td>\n","      <td>0.151541</td>\n","      <td>-0.458079</td>\n","      <td>-0.141782</td>\n","      <td>0.367425</td>\n","      <td>0.035769</td>\n","      <td>0.846413</td>\n","      <td>-0.499267</td>\n","      <td>-0.077148</td>\n","      <td>-0.140418</td>\n","      <td>0.231476</td>\n","      <td>0.734651</td>\n","      <td>-0.780837</td>\n","      <td>-0.758331</td>\n","      <td>-0.045737</td>\n","      <td>0.151879</td>\n","      <td>0.273747</td>\n","      <td>-0.255779</td>\n","      <td>0.751151</td>\n","    </tr>\n","    <tr>\n","      <th>127494</th>\n","      <td>-0.274314</td>\n","      <td>-0.647603</td>\n","      <td>-0.955129</td>\n","      <td>0.209327</td>\n","      <td>-1.331333</td>\n","      <td>1.254131</td>\n","      <td>-0.616953</td>\n","      <td>-0.708369</td>\n","      <td>-0.404241</td>\n","      <td>0.256229</td>\n","      <td>-0.815763</td>\n","      <td>-0.450185</td>\n","      <td>0.381396</td>\n","      <td>-0.346030</td>\n","      <td>-0.240756</td>\n","      <td>0.337484</td>\n","      <td>0.346845</td>\n","      <td>0.751972</td>\n","      <td>-0.573303</td>\n","      <td>0.239783</td>\n","      <td>-0.115848</td>\n","      <td>-0.698325</td>\n","      <td>1.538709</td>\n","      <td>-0.072139</td>\n","      <td>-0.376177</td>\n","      <td>-0.030284</td>\n","      <td>0.365656</td>\n","      <td>0.273749</td>\n","      <td>-0.007722</td>\n","      <td>0.245693</td>\n","    </tr>\n","    <tr>\n","      <th>127495</th>\n","      <td>0.010383</td>\n","      <td>-0.024200</td>\n","      <td>0.031024</td>\n","      <td>1.145018</td>\n","      <td>0.256624</td>\n","      <td>-0.206164</td>\n","      <td>0.167912</td>\n","      <td>0.296381</td>\n","      <td>-0.628812</td>\n","      <td>1.120059</td>\n","      <td>-0.396249</td>\n","      <td>-0.106362</td>\n","      <td>0.750486</td>\n","      <td>-0.026959</td>\n","      <td>-0.311179</td>\n","      <td>0.372232</td>\n","      <td>0.145537</td>\n","      <td>0.833605</td>\n","      <td>1.292957</td>\n","      <td>0.106868</td>\n","      <td>-0.174809</td>\n","      <td>1.528198</td>\n","      <td>0.171421</td>\n","      <td>0.164048</td>\n","      <td>-0.189416</td>\n","      <td>-0.656136</td>\n","      <td>-0.053700</td>\n","      <td>-0.360702</td>\n","      <td>-0.674525</td>\n","      <td>0.947409</td>\n","    </tr>\n","  </tbody>\n","</table>\n","<p>127448 rows × 30 columns</p>\n","</div>"],"text/plain":["               0         1         2  ...        27        28        29\n","userid                                ...                              \n","0      -0.414023  0.573671 -0.466751  ... -0.371089 -0.086386  0.669767\n","1      -0.473889 -0.131186  0.104379  ... -0.213119  0.152553  0.554046\n","2      -0.083034  0.034994  0.262354  ... -0.013698 -0.374472  0.526813\n","3      -0.207925 -0.154537  0.200064  ... -0.231564 -0.040502  0.450197\n","4      -0.562584 -0.298769  0.687209  ... -0.415195 -0.082853  0.344746\n","...          ...       ...       ...  ...       ...       ...       ...\n","127491 -0.171731 -0.292508 -0.084355  ... -0.282298  0.308017  0.732400\n","127492 -0.117186 -0.032770  0.206553  ... -0.107245 -0.618327  1.007551\n","127493 -0.293894 -0.303011 -0.067055  ...  0.273747 -0.255779  0.751151\n","127494 -0.274314 -0.647603 -0.955129  ...  0.273749 -0.007722  0.245693\n","127495  0.010383 -0.024200  0.031024  ... -0.360702 -0.674525  0.947409\n","\n","[127448 rows x 30 columns]"]},"metadata":{"tags":[]},"execution_count":16}]},{"cell_type":"code","metadata":{"id":"yhfrJuZzal6P","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":51},"executionInfo":{"status":"ok","timestamp":1596026084749,"user_tz":-180,"elapsed":575249,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"2d6b02eb-2ad2-42d7-ad49-3df6758088ff"},"source":["%%time\n","#Разделим всех пользователй на группы, чтобы потом сделать фичи по пользователям\n","from sklearn.cluster import KMeans\n","\n","# Создаём KMeans кластеризатор \n","kmeans = KMeans(n_clusters=100)\n","\n","# Обучаем кластеризатор на подготовленных данных\n","kmeans.fit(fichi_user.to_numpy())\n","\n","# Получаем предсказанные кластеры\n","y_pred = kmeans.labels_.astype(np.int)"],"execution_count":null,"outputs":[{"output_type":"stream","text":["CPU times: user 10min 24s, sys: 4min 38s, total: 15min 3s\n","Wall time: 9min 34s\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"IZ2ElqpoqMjz","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":419},"executionInfo":{"status":"ok","timestamp":1596026441959,"user_tz":-180,"elapsed":636,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"a2ed10a6-4b1c-486c-a4bf-da0fefcc3332"},"source":["#Объединим пользователей и их номер кластера в один датафрейм, подготовим данные для передачи в модель\n","fichi_user_indx = pd.concat([pd.DataFrame(fichi_user.reset_index()['userid']), pd.DataFrame(y_pred, columns =['label'])], axis =1)\n","fichi_user_indx['userid'] = fichi_user_indx['userid'].astype('int')\n","fichi_user_indx['user_features'] = fichi_user_indx.apply(lambda x:(int(x.userid), [int(x.label)]), axis =1)\n","fichi_user_indx"],"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/html":["<div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>userid</th>\n","      <th>label</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>0</td>\n","      <td>22</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>1</td>\n","      <td>44</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>2</td>\n","      <td>2</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>3</td>\n","      <td>80</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>4</td>\n","      <td>86</td>\n","    </tr>\n","    <tr>\n","      <th>...</th>\n","      <td>...</td>\n","      <td>...</td>\n","    </tr>\n","    <tr>\n","      <th>127443</th>\n","      <td>127491</td>\n","      <td>61</td>\n","    </tr>\n","    <tr>\n","      <th>127444</th>\n","      <td>127492</td>\n","      <td>2</td>\n","    </tr>\n","    <tr>\n","      <th>127445</th>\n","      <td>127493</td>\n","      <td>26</td>\n","    </tr>\n","    <tr>\n","      <th>127446</th>\n","      <td>127494</td>\n","      <td>82</td>\n","    </tr>\n","    <tr>\n","      <th>127447</th>\n","      <td>127495</td>\n","      <td>74</td>\n","    </tr>\n","  </tbody>\n","</table>\n","<p>127448 rows × 2 columns</p>\n","</div>"],"text/plain":["        userid  label\n","0            0     22\n","1            1     44\n","2            2      2\n","3            3     80\n","4            4     86\n","...        ...    ...\n","127443  127491     61\n","127444  127492      2\n","127445  127493     26\n","127446  127494     82\n","127447  127495     74\n","\n","[127448 rows x 2 columns]"]},"metadata":{"tags":[]},"execution_count":24}]},{"cell_type":"code","metadata":{"id":"_ovjWRre21Mp","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":51},"executionInfo":{"status":"ok","timestamp":1596026491732,"user_tz":-180,"elapsed":1709,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"573243cf-89f3-42f9-fd9a-b45530d53fd5"},"source":["# Проверим , что между  asin и itemid однозначное соответствие, что данные корректны\n","data_all = pd.concat([data, test])\n","data_all_test = pd.DataFrame(data_all.groupby(['asin']).itemid.max() - data_all.groupby(['asin']).itemid.min())\n","data_all_test.itemid.value_counts()\n","# должен быть ноль по всей длине датафрейма"],"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["0    41320\n","Name: itemid, dtype: int64"]},"metadata":{"tags":[]},"execution_count":28}]},{"cell_type":"code","metadata":{"id":"3quzEyZn67At","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":34},"executionInfo":{"status":"ok","timestamp":1596026494121,"user_tz":-180,"elapsed":1114,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"a5084c57-9670-42fe-9b8e-0ffbe0620d2f"},"source":["#Словарь соответствия asin и itemid\n","mapper = dict(zip(data_all.asin, data_all.itemid))\n","len(mapper)"],"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["41320"]},"metadata":{"tags":[]},"execution_count":29}]},{"cell_type":"code","metadata":{"id":"cUncxrwiuimG","colab_type":"code","colab":{}},"source":["import json\n","def get_by_key(field, dict_from, dict_to):\n","   if field in dict_from.keys():\n","       dict_to[mapper.get(dict_from.get('asin'))] = dict_from.get(field)    \n","\n","with open(DIR + 'meta_Grocery_and_Gourmet_Food_small.json') as file:\n","     d_main_category = {}\n","     d_brand = {}\n","     d_category = {}\n","     for line in file.readlines(): \n","         lines = json.loads(line) \n","         get_by_key('brand', lines, d_brand)\n","         get_by_key('main_cat', lines, d_main_category)\n","         get_by_key('category', lines, d_category)\n"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"V1OaZH-nMLuz","colab_type":"code","colab":{}},"source":["set_itemid = set(data['itemid']) | set(test['itemid']) \n","#Подготовим словари с фичами для модели, обеспечим уникальность значения\n","d_brand_ml =  {x:'brand:' + y for x,y in d_brand.items()}\n","d_main_category_ml = {x:'main_cat:' + y for x,y in d_main_category.items()}\n","#Поиграем самой категорией, возьмем самый нижний уровень\n","d_last_category_ml = {x:'last_cat:' + y[-1] for x,y in d_category.items()}"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"rkNGRX8zMKJx","colab_type":"code","colab":{}},"source":["#Разбиваем наш датасет на обучающую и тестовую выборки\n","train_data, test_data = train_test_split(data,random_state=32, shuffle=True) #, test_size = 0.25)"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"AKfiEm_Pyzmi","colab_type":"code","colab":{}},"source":["#Формируем  mapping для всех пользователей и товаров(train + test)\n","\n","dataset = Dataset() #item_identity_features=False)\n","dataset.fit((x for x in pd.concat([data, test])['userid']),\n","            (x for x in pd.concat([data, test])['itemid']))"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"6PTzxNWwzw7x","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":34},"executionInfo":{"status":"ok","timestamp":1594658107013,"user_tz":-180,"elapsed":929,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"27cbb0ec-7b50-460a-8a7c-aa58e4e19e9d"},"source":["num_users, num_items = dataset.interactions_shape()\n","print('Num users: {}, num_items {}.'.format(num_users, num_items))"],"execution_count":null,"outputs":[{"output_type":"stream","text":["Num users: 127496, num_items 41320.\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"kcIkOqXh6fGo","colab_type":"code","colab":{}},"source":["# Добавляем фичи по товарам в dataset\n","dataset.fit_partial(items=(x for x in d_last_category_ml.keys()),\n","                    item_features=(x for x in d_last_category_ml.values()))\n","\n","dataset.fit_partial(items=(x for x in d_main_category_ml.keys()),\n","                    item_features=(x for x in d_main_category_ml.values()))\n","\n","dataset.fit_partial(items=(x for x in d_brand_ml.keys()),\n","                    item_features=(x for x in d_brand_ml.values()))"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"HeS8SIC0xBgJ","colab_type":"code","colab":{}},"source":["# Добавляем фичи по пользователям в dataset\n","dataset.fit_partial(users=fichi_user_indx['userid'],\n","                          user_features=fichi_user_indx['label'])"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"kaKhrF3I0az8","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":51},"executionInfo":{"status":"ok","timestamp":1596028322758,"user_tz":-180,"elapsed":3248,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"8cd199bd-7925-411e-a0ff-7f4422b21d66"},"source":["#Готовим основную матрицу\n","(interactions, weights) = dataset.build_interactions(((x,y,z) \n","                for x,y, z in zip(train_data.userid.values,train_data.itemid.values, train_data.rating.values)))\n","              #  for x,y, z in zip(data.userid.values,data.itemid.values, data.rating.values)))\n","\n","print(repr(interactions))"],"execution_count":null,"outputs":[{"output_type":"stream","text":["<127496x41320 sparse matrix of type '<class 'numpy.int32'>'\n","\twith 806942 stored elements in COOrdinate format>\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"JT_G0jjUR8WS","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":51},"executionInfo":{"status":"ok","timestamp":1596028325635,"user_tz":-180,"elapsed":813,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"cc403a3b-a32a-4a9f-b84d-c237ccecfb55"},"source":["# Добавляем фичи по товарам \n","def get_item_features(itemid):\n","   def add_from_dict(dict_):\n","      if dict_.get(itemid):\n","         list_feat.append(dict_.get(itemid)) \n","\n","   list_feat =[]\n","   add_from_dict(d_brand_ml)\n","   add_from_dict(d_last_category_ml)\n","   add_from_dict(d_main_category_ml)\n","   return list_feat\n","\n","item_features = dataset.build_item_features(((x, get_item_features(x))\n","                                                       for x in set_itemid ))\n","print(repr(item_features))"],"execution_count":null,"outputs":[{"output_type":"stream","text":["<41320x51173 sparse matrix of type '<class 'numpy.float32'>'\n","\twith 164772 stored elements in Compressed Sparse Row format>\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"ZnHM0t6yx7Rr","colab_type":"code","colab":{}},"source":["# Добавляем фичи по пользователям\n","user_features = dataset.build_user_features((x for x in list(fichi_user_indx['user_features'])))"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"q-AIr1ds9DEl","colab_type":"code","colab":{}},"source":["# Вытаскиваем словари для преобразований\n","user_id_map, user_feature_map, item_id_map, item_feature_map = dataset.mapping()"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"Yxut01m9Vnuy","colab_type":"code","colab":{}},"source":["from lightfm import LightFM\n","NUM_THREADS = 8 #число потоков\n","RANDOM_SEED = 32\n","#Гиперпараметры\n","#NUM_EPOCHS, LEARNING_RATE, NUM_COMPONENTS, ALPHA =  [108,0.9307615113531499,156,1.117646374973343e-06]\n","#params = [15,0.1,120,0]  #стартовые параметры\n","#params = [108,0.9307615113531499,156,1.117646374973343e-06] # без фич\n","params =  [54, 0.6695553384725956, 90, 4.527672167401107e-06] #с фичами"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"liVMBr2BVTrd","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":219,"referenced_widgets":["c05b0563475b49a4ab3f383b15c38c66","5cf13be2b24c434881f7dfc6f90b24d6","b61fbf0a1437490fbdc719079ab99bff","a6d0df852f7a44bb817eecd097f4357a","7662d4ede2b94ad9a222ef11f8004497","2eda7c5dd8514e5f93040281634560a6","cc7ea319ec424f0097f9e11c937e2d9a","a1f93844fc394bbfa8eab2ec23c4349a"]},"executionInfo":{"status":"ok","timestamp":1596027967171,"user_tz":-180,"elapsed":1224073,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"6799b3f4-7b49-4284-cc2c-da30747de997"},"source":["def prediction_model(mtype, h_params, mat_weights):\n","    num_epochs, learning_rate, num_components, alpha = h_params\n","    model = LightFM(learning_rate = learning_rate, \n","                          loss = mtype, \n","                          no_components = num_components,\n","                          random_state = RANDOM_SEED,\n","                          user_alpha = alpha,\n","                          item_alpha = alpha)\n","    model = model.fit(mat_weights, epochs=num_epochs, num_threads=NUM_THREADS\n","                              , item_features=item_features\n","                      , user_features=user_features\n","                              ) \n","    \n","    return(model)\n","\n","\n","N_FOLDS = 5\n","sample_submissions = pd.DataFrame(0,columns=[\"sub_1\"], index=submission.index) # куда пишем предикты по каждой модели\n","score_ls = []\n","X = data[['userid','itemid']]\n","y = data.rating\n","#splits = list(KFold(n_splits=N_FOLDS, shuffle=True, random_state=RANDOM_SEED).split(X, y))\n","\n","splits = list(StratifiedKFold(n_splits=N_FOLDS, shuffle=True, random_state=RANDOM_SEED).split(X, y))\n","\n","\n","for idx, (train_idx, test_idx) in tqdm(enumerate(splits), total=N_FOLDS,):\n","    # use the indexes to extract the folds in the train and validation data\n","    X_train, y_train, X_test, y_test = X.iloc[train_idx], y[train_idx], X.iloc[test_idx], y[test_idx]\n","    # Строим разреженную матрицу \n","#Готовим основную матрицу\n","    (interactions, weights_train) = dataset.build_interactions(((x,y,z) \n","                for x,y, z in zip(X_train.userid.values, X_train.itemid.values, y_train)))\n","    # model for this fold\n","    model_light = prediction_model('logistic', params, weights_train)\n","\n","    # score model on test\n","    test_predict = model_light.predict(X_test.userid.apply(lambda x: user_id_map[x]).values,\n","                              X_test.itemid.apply(lambda x: item_id_map[x]).values \n","                             ,item_features=item_features\n","                             , user_features=user_features\n","                             )\n","\n","    test_score = sklearn.metrics.roc_auc_score(y_test,test_predict)\n","    score_ls.append(test_score)\n","    print(f\"{idx+1} Fold Test MAPE: {test_score:0.4f}\")\n","    # submissions\n","    # submissions\n","    sample_submissions[f'sub_{idx+1}'] = model_light.predict(test.userid.apply(lambda x: user_id_map[x]).values,\n","                                                             test.itemid.apply(lambda x: item_id_map[x]).values\n","                                                             ,item_features=item_features \n","                                                             , user_features=user_features\n","                                                              )\n","    \n","print(f'Mean Score: {np.mean(score_ls):0.5f}')\n","print(f'Std Score: {np.std(score_ls):0.5f}')\n","print(f'Max Score: {np.max(score_ls):0.5f}')\n","print(f'Min Score: {np.min(score_ls):0.5f}')    "],"execution_count":null,"outputs":[{"output_type":"display_data","data":{"application/vnd.jupyter.widget-view+json":{"model_id":"c05b0563475b49a4ab3f383b15c38c66","version_minor":0,"version_major":2},"text/plain":["HBox(children=(FloatProgress(value=0.0, max=5.0), HTML(value='')))"]},"metadata":{"tags":[]}},{"output_type":"stream","text":["1 Fold Test MAPE: 0.7550\n","2 Fold Test MAPE: 0.7565\n","3 Fold Test MAPE: 0.7517\n","4 Fold Test MAPE: 0.7549\n","5 Fold Test MAPE: 0.7548\n","\n","Mean Score: 0.75458\n","Std Score: 0.00158\n","Max Score: 0.75648\n","Min Score: 0.75166\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"fzKsvPWzm6B4","colab_type":"code","colab":{}},"source":["sample_submissions['res'] = sample_submissions.mean(axis=1)\n","preds = sample_submissions['res']\n","normalized_preds = (preds - preds.min())/(preds - preds.min()).max()\n","submission['rating']= normalized_preds"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"0X3_H4AWrqjl","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":419},"executionInfo":{"status":"ok","timestamp":1596028008470,"user_tz":-180,"elapsed":684,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"f70d69ce-1dd4-42ea-e189-6cff26ddbb9f"},"source":["submission"],"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/html":["<div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Id</th>\n","      <th>rating</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>0</td>\n","      <td>0.635997</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>1</td>\n","      <td>0.610852</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>2</td>\n","      <td>0.607010</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>3</td>\n","      <td>0.452351</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>4</td>\n","      <td>0.506215</td>\n","    </tr>\n","    <tr>\n","      <th>...</th>\n","      <td>...</td>\n","      <td>...</td>\n","    </tr>\n","    <tr>\n","      <th>285960</th>\n","      <td>285960</td>\n","      <td>0.679087</td>\n","    </tr>\n","    <tr>\n","      <th>285961</th>\n","      <td>285961</td>\n","      <td>0.404251</td>\n","    </tr>\n","    <tr>\n","      <th>285962</th>\n","      <td>285962</td>\n","      <td>0.509674</td>\n","    </tr>\n","    <tr>\n","      <th>285963</th>\n","      <td>285963</td>\n","      <td>0.584099</td>\n","    </tr>\n","    <tr>\n","      <th>285964</th>\n","      <td>285964</td>\n","      <td>0.661063</td>\n","    </tr>\n","  </tbody>\n","</table>\n","<p>285965 rows × 2 columns</p>\n","</div>"],"text/plain":["            Id    rating\n","0            0  0.635997\n","1            1  0.610852\n","2            2  0.607010\n","3            3  0.452351\n","4            4  0.506215\n","...        ...       ...\n","285960  285960  0.679087\n","285961  285961  0.404251\n","285962  285962  0.509674\n","285963  285963  0.584099\n","285964  285964  0.661063\n","\n","[285965 rows x 2 columns]"]},"metadata":{"tags":[]},"execution_count":43}]},{"cell_type":"code","metadata":{"id":"Wg1gFidKrwv1","colab_type":"code","colab":{}},"source":["VERSION = 23\n","submission.to_csv(DIR_TEST+ f'submission_v{VERSION}.csv', index=False)"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"yV8CbKHMOKde","colab_type":"code","colab":{"base_uri":"https://localhost:8080/","height":419},"executionInfo":{"status":"ok","timestamp":1596028794711,"user_tz":-180,"elapsed":598,"user":{"displayName":"Марина Иванова","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gg7hezV5y6KHcNMC5xYLMsxx1iVkk9vOkYW2LsY=s64","userId":"06293143360819199290"}},"outputId":"dcd65e60-80ea-452d-9396-bd86ad7bf028"},"source":["submission"],"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/html":["<div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Id</th>\n","      <th>rating</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>0</td>\n","      <td>0.650563</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>1</td>\n","      <td>0.615751</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>2</td>\n","      <td>0.607787</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>3</td>\n","      <td>0.452588</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>4</td>\n","      <td>0.524707</td>\n","    </tr>\n","    <tr>\n","      <th>...</th>\n","      <td>...</td>\n","      <td>...</td>\n","    </tr>\n","    <tr>\n","      <th>285960</th>\n","      <td>285960</td>\n","      <td>0.683191</td>\n","    </tr>\n","    <tr>\n","      <th>285961</th>\n","      <td>285961</td>\n","      <td>0.426928</td>\n","    </tr>\n","    <tr>\n","      <th>285962</th>\n","      <td>285962</td>\n","      <td>0.507427</td>\n","    </tr>\n","    <tr>\n","      <th>285963</th>\n","      <td>285963</td>\n","      <td>0.589488</td>\n","    </tr>\n","    <tr>\n","      <th>285964</th>\n","      <td>285964</td>\n","      <td>0.678327</td>\n","    </tr>\n","  </tbody>\n","</table>\n","<p>285965 rows × 2 columns</p>\n","</div>"],"text/plain":["            Id    rating\n","0            0  0.650563\n","1            1  0.615751\n","2            2  0.607787\n","3            3  0.452588\n","4            4  0.524707\n","...        ...       ...\n","285960  285960  0.683191\n","285961  285961  0.426928\n","285962  285962  0.507427\n","285963  285963  0.589488\n","285964  285964  0.678327\n","\n","[285965 rows x 2 columns]"]},"metadata":{"tags":[]},"execution_count":61}]},{"cell_type":"markdown","metadata":{"id":"XWlnrSQB4AEL","colab_type":"text"},"source":["Отличный результат на тесте, но на каггле дает только 0.77494"]}]}